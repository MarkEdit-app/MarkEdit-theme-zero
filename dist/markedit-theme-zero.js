"use strict";const U=require("@codemirror/state"),a=require("@lezer/highlight"),m=require("markedit-api"),D=require("@codemirror/view"),P=require("@codemirror/language"),k=(t,n={})=>t??n,F=k(m.MarkEdit.userSettings),x=q("extension.markeditTheming"),z=p(!1)?k(x.lightTheme):void 0,J=p(!0)?k(x.darkTheme):void 0;function q(t){return t===void 0?{}:k(F[t])}function L(t){return t.enabledMode??"both"}function p(t,n=L(x)){return["both",t?"dark":"light"].includes(n)}function Q(t,n,c){const o=W({lhs:c,rhs:t?J:z});return{extensions:[...t?_(o,{dark:!0}):_(o),n].filter(e=>e!==void 0),colors:o}}function _(t,n){const c={},o=[],r=t.editor,e=t.highlight;r?.textColor&&(c["&"]??={},c["&"].color=r?.textColor,c[".cm-activeLineGutter"]={backgroundColor:r?.textColor}),r?.backgroundColor&&(c["&"]??={},c["&"].backgroundColor=r?.backgroundColor),r?.activeLineBackground&&(c[".cm-activeLine"]={backgroundColor:r?.activeLineBackground}),r?.caretColor&&(c[".cm-content"]={caretColor:r?.caretColor},c[".cm-cursor, .cm-dropCursor"]={borderLeftColor:r?.caretColor}),r?.selectionBackground&&(c["&.cm-focused > .cm-scroller > .cm-selectionLayer .cm-selectionBackground, .cm-selectionBackground, .cm-content ::selection"]={backgroundColor:r?.selectionBackground}),r?.matchingBracketBackground&&(c["&.cm-focused .cm-matchingBracket, &.cm-focused .cm-nonmatchingBracket"]={backgroundColor:r?.matchingBracketBackground}),r?.gutterText&&(c[".cm-gutters"]??={},c[".cm-gutters"].color=r?.gutterText),r?.gutterBackground&&(c[".cm-gutters"]??={},c[".cm-gutters"].backgroundColor=r?.gutterBackground,c[".cm-gutters"].border="none"),r?.foldPlaceholderText&&(c[".cm-foldPlaceholder"]??={},c[".cm-foldPlaceholder"].color=r?.foldPlaceholderText),r?.foldPlaceholderBackground&&(c[".cm-foldPlaceholder"]??={},c[".cm-foldPlaceholder"].backgroundColor=r?.foldPlaceholderBackground,c[".cm-foldPlaceholder"].border="none"),r?.searchMatchBackground&&(c[".cm-searchMatch"]={backgroundColor:r?.searchMatchBackground}),r?.selectionMatchBackground&&(c[".cm-selectionMatch"]={backgroundColor:r?.selectionMatchBackground}),e?.heading&&o.push({tag:a.tags.heading,color:e?.heading}),e?.bold&&o.push({tag:a.tags.strong,color:e?.bold}),e?.italic&&o.push({tag:a.tags.emphasis,color:e?.italic}),e?.strikethrough&&o.push({tag:a.tags.strikethrough,color:e?.strikethrough}),e?.quote&&o.push({tag:a.tags.quote,color:e?.quote}),e?.link&&o.push({tag:[a.tags.url,a.tags.link],color:e?.link}),e?.separator&&o.push({tag:[a.tags.definition(a.tags.name),a.tags.separator,a.tags.contentSeparator],color:e?.separator}),e?.comment&&o.push({tag:a.tags.comment,color:e?.comment}),e?.meta&&o.push({tag:a.tags.meta,color:e?.meta}),e?.keyword&&o.push({tag:a.tags.keyword,color:e?.keyword}),e?.atom&&o.push({tag:[a.tags.atom,a.tags.bool],color:e?.atom}),e?.literal&&o.push({tag:[a.tags.literal,a.tags.inserted],color:e?.literal}),e?.string&&o.push({tag:[a.tags.string,a.tags.deleted],color:e?.string}),e?.special&&o.push({tag:[a.tags.regexp,a.tags.escape,a.tags.special(a.tags.string)],color:e?.special}),e?.variable&&o.push({tag:a.tags.definition(a.tags.variableName),color:e?.variable}),e?.local&&o.push({tag:a.tags.local(a.tags.variableName),color:e?.local}),e?.type&&o.push({tag:[a.tags.typeName,a.tags.namespace],color:e?.type}),e?.class&&o.push({tag:a.tags.className,color:e?.class}),e?.macro&&o.push({tag:[a.tags.special(a.tags.variableName),a.tags.macroName],color:e?.macro}),e?.property&&o.push({tag:a.tags.definition(a.tags.propertyName),color:e?.property}),e?.label&&o.push({tag:a.tags.labelName,color:e?.label}),e?.operator&&o.push({tag:[a.tags.operator,a.tags.operatorKeyword],color:e?.operator}),e?.constant&&o.push({tag:[a.tags.color,a.tags.constant(a.tags.name),a.tags.standard(a.tags.name)],color:e?.constant}),e?.instruction&&o.push({tag:a.tags.processingInstruction,color:e?.instruction}),e?.invalid&&o.push({tag:a.tags.invalid,color:e?.invalid});const u=[];return Object.keys(c).length>0&&u.push(D.EditorView.theme(c,n)),o.length>0&&u.push(P.syntaxHighlighting(P.HighlightStyle.define(o))),u}function W(t){return{editor:{...t.lhs?.editor,...t.rhs?.editor},highlight:{...t.lhs?.highlight,...t.rhs?.highlight},subtleEmphasis:t.rhs?.subtleEmphasis??t.lhs?.subtleEmphasis}}const s={selectionBackground:".cm-selectionBackground",lineGutter:".cm-lineNumbers > .cm-activeLineGutter",foldGutter:".cm-foldGutter, .cm-foldPlaceholder",visibleSpace:".cm-visibleSpace, .cm-visibleSpace::before, .cm-visibleLineBreak, .cm-visibleLineBreak::before",matchingBracket:".cm-matchingBracket",activeIndicator:".cm-md-activeIndicator",emphasisElement:".cm-md-bold:not(.tok-meta), .cm-md-italic:not(.tok-meta), .cm-md-quote:not(.cm-md-quoteMark)",accentColor:".cm-md-header:not(.tok-meta):not(.cm-md-quote), .cm-md-codeInfo",syntaxMarker:".cm-md-header.tok-meta:not(.cm-md-quote), .cm-md-codeMark, .cm-md-linkMark, .cm-md-listMark, .cm-md-quoteMark"},X=`
.cm-activeLineGutter { background: inherit !important }
.cm-searchMatch.cm-searchMatch-selected { outline: inherit !important }
${s.lineGutter} {}
${s.foldGutter} {}
${s.visibleSpace} {}
${s.matchingBracket} {}
${s.activeIndicator} {}
${s.emphasisElement} {}
${s.accentColor} {}
${s.syntaxMarker} {}
`,N=window,Y=N.__extractStyleRules__??(t=>t.value?.rules),Z=N.__extractHighlightSpecs__??(t=>t.value?.specs);function ee(t){const n=document.createElement("style");return n.textContent=t,document.head.appendChild(n),n}function te(t){if(t.length===0)return[{},[]];const n=C(t);return[Object.fromEntries(n.flatMap(o=>{const r=Y(o)?.join(`
`)??"";return Object.entries(re(r))})),n.flatMap(o=>Z(o)??[])]}function $(t,n){return t.find(c=>!!(c.tag.toString().includes(n.toString())&&c.color!==void 0))?.color}function v(t,n,c){for(const[o,r]of Object.entries(t))if(o.includes(n)&&(c===void 0||!o.includes(c))){const e=r.background??r.backgroundColor;if(e!==void 0)return e}}function oe(t){const n=t.match(/rgba?\((\d+), (\d+), (\d+)(?:, ([\d.]+))?\)/);if(n===null)return;const[c,o,r]=n.slice(1,4).map(Number);return`rgba(${c}, ${o}, ${r}, 0.6)`}function O(t){const n=r=>r!==null&&typeof r=="object";if(!n(t))return!0;const c=Object.entries(t),o=r=>r!=null;for(const[,r]of c)if(n(r)){if(!O(r))return!1}else if(o(r))return!1;return!0}function C(t){return Array.isArray(t)?t.flatMap(C):"extension"in t?C(t.extension):[t]}function re(t){const n={},c=new CSSStyleSheet;c.replaceSync(t);for(const o of c.cssRules){const{style:r,selectorText:e}=o,{background:u,backgroundColor:g}=r;n[e]={},u.length>0&&(n[e].background=u),g.length>0&&(n[e].backgroundColor=g)}return n}function ce(t){const n=t.options?.settingsKey,c=L(q(n));t.light!==void 0&&p(!1,c)&&(i().customThemes.light=t.light),t.dark!==void 0&&p(!0,c)&&(i().customThemes.dark=t.dark),typeof m.MarkEdit.editorView=="object"&&B(m.MarkEdit.editorView)}const f=window,i=()=>f.__markeditTheming__,j=matchMedia("(prefers-color-scheme: dark)");typeof i()!="object"&&ae();function ae(){f.__markeditTheming__={styleSheet:ee(X),configurator:new U.Compartment,customThemes:{},lightOriginalRules:{},darkOriginalRules:{}},m.MarkEdit.addExtension(i().configurator.of([])),m.MarkEdit.onEditorReady(n=>B(n));const t=()=>setTimeout(()=>B(m.MarkEdit.editorView),15);j.addEventListener("change",t),i().mainThemeName=f.config.theme,Object.defineProperty(f.config,"theme",{get(){return i().mainThemeName},set(n){i().mainThemeName=n,t()}})}function B(t){const n=j.matches,c=n?i().customThemes.dark:i().customThemes.light,{extensions:o,colors:r}=Q(n,c?.extension,c?.colors);t.dispatch({effects:i().configurator.reconfigure(o)});const[e,u]=te(o),g=o.length===0&&O(r);i().styleSheet.disabled=g,ne(t,n,g,e,u,r)}function ne(t,n,c,o,r,e){const u=v(o,".cm-activeLine",".cm-activeLineGutter"),g=v(o,s.selectionBackground),G=v(o,s.matchingBracket),T=getComputedStyle(t.contentDOM).color,M=e.editor?.visibleSpaceColor??oe(T),S=$(r,a.tags.heading),R=$(r,a.tags.processingInstruction),I=[[s.activeIndicator,u,"background"],[s.matchingBracket,G,"background"],[s.lineGutter,T,"color"],[s.foldGutter,M,"color"],[s.visibleSpace,M,"color"],[s.accentColor,S,"color"],[s.syntaxMarker,R,"color"]],V=Array.from(document.querySelectorAll("style")),h=n?i().darkOriginalRules:i().lightOriginalRules;for(const H of V){const b=H.sheet?.cssRules;if(b!==void 0)for(let y=0;y<b.length;++y){const l=b[y],d=l.selectorText??"";d.includes(".cm-focused")&&d.includes(s.selectionBackground)&&(h.selectionBackground??=l.cssText,c?l.cssText=h.selectionBackground:g!==void 0&&l.style.setProperty("background",g,"important")),S!==void 0&&(d===".cm-md-header"||d===".cm-md-header:not(.cm-md-quote)")&&(h.markdownHeader??=l.cssText,c?l.cssText=h.markdownHeader:l.style.removeProperty("color"));for(const[A,E,w]of I)if(d===A)if(E===void 0)l.style.removeProperty(w);else{const K=[s.accentColor,s.syntaxMarker].includes(d)?void 0:"important";l.style.setProperty(w,E,K),(d===s.matchingBracket||d===s.activeIndicator)&&l.style.setProperty("box-shadow","unset","important")}d===s.emphasisElement&&(e.subtleEmphasis??!0?l.style.setProperty("color","inherit","important"):l.style.removeProperty("color"))}}}ce({});
